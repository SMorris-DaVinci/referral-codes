<!-- gateway-trojan.html â€” silent validate+redirect -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title></title>
  <style>
    /* Keep page fully blank; only show if we hit an error */
    html, body { margin:0; padding:0; background:#fff; }
    body { display:none; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width:640px; margin:16vh auto; padding:0 16px; line-height:1.5; color:#111; }
  </style>
  <noscript><style>body{display:block}</style></noscript>
</head>
<body>
  <div class="wrap" id="msg" role="alert" aria-live="assertive"></div>

  <script>
  (async () => {
    const params = new URLSearchParams(location.search);
    const ref = (params.get('ref') || '').trim();
    const BOOK = 'trojan';
    const KOFI_PROLOGUE_URL = 'https://ko-fi.com/post/Prologue--Cold-War-Open--By-Bailey-Ryder-A0A51I0KH0';
    const API_BASE = 'https://referral-codes-ten.vercel.app';

    const fail = (text) => {
      // Only on failure do we reveal the page
      document.getElementById('msg').textContent = text;
      document.body.style.display = 'block';
    };

    try {
      if (!ref || ref.length < 4) return fail('Page-link blocked. Referral code invalid, or not found.');

      // Validate against single-column CSV (no header)
      const r = await fetch('https://raw.githubusercontent.com/SMorris-DaVinci/referral-codes/main/codes-trojan.csv', { cache: 'no-store' });
      if (!r.ok) throw new Error('codes fetch failed');
      const txt = await r.text();
      const ok = txt.split(/\r?\n/).some(line => line.trim() === ref);
      if (!ok) return fail('Page-link blocked. Referral code invalid, or not found.');

      // Session id (persisted)
      let sessionID = localStorage.getItem('session_id');
      if (!sessionID) {
        sessionID = (crypto.randomUUID ? crypto.randomUUID() : (Date.now()+'-'+Math.random().toString(36).slice(2)));
        localStorage.setItem('session_id', sessionID);
      }

      // Persist a couple of handy values (not visible)
      localStorage.setItem('ref', ref);
      localStorage.setItem('book', BOOK);

      // Non-blocking log (no UI, no await needed, but keep a short timeout)
      try {
        const ctl = new AbortController();
        setTimeout(() => ctl.abort(), 1200);
        fetch(`${API_BASE}/api/log`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ref,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            chapter: '',
            book: BOOK,
            tipIntent: false,
            localStorage: JSON.stringify({ ref, book: BOOK }),
            sourceURL: document.referrer || '',
            ipAddress: '',
            urlParamsRaw: location.search.slice(1),
            sessionID
          }),
          signal: ctl.signal
        }).catch(()=>{});
      } catch(_) {}

      // Silent forward (no history entry, no text shown)
      location.replace(KOFI_PROLOGUE_URL);

    } catch {
      fail('Page-link blocked. Referral code invalid, or not found.');
    }
  })();
  </script>
</body>
</html>
