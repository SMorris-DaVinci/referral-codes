<script>
  window.addEventListener("DOMContentLoaded", async () => {
    const endpoint = "https://litocracy-referral.vercel.app/api/log";
    const ref = new URLSearchParams(window.location.search).get("ref");
    const chapter = "Prologue";
    const book = "Trojan Horse";
    const tipIntent = localStorage.getItem("tipIntent") || "";
    const localStorageDump = JSON.stringify(localStorage);
    const sourceURL = document.referrer;
    const ipAddress = ""; // leave empty for now
    const urlParamsRaw = window.location.search;
    const timestamp = new Date().toISOString();
    const userAgent = navigator.userAgent;

    const logData = {
      ref,
      timestamp,
      userAgent,
      chapter,
      book,
      tipIntent,
      localStorage: localStorageDump,
      sourceURL,
      ipAddress,
      urlParamsRaw
    };

    try {
      const response = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(logData)
      });

      const result = await response.json();
      console.log("Referral log response:", result);
    } catch (err) {
      console.error("Error sending referral log:", err);
    }
  });
</script>
