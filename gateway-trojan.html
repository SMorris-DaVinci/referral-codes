<!-- gateway-trojan.html (silent redirect + validation) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title></title>
  <style>
    /* Keep the page visually blank unless we need to show an error */
    html, body { background:#fff; margin:0; padding:0; }
    body { display:none; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width: 640px; margin: 16vh auto; padding: 0 16px; line-height: 1.5; color: #111; }
  </style>
  <noscript>
    <style>body{display:block}</style>
  </noscript>
</head>
<body>
  <!-- Only shown if invalid or JS disabled -->
  <div class="wrap" id="msg" role="alert" aria-live="assertive"></div>

  <script>
    (async () => {
      const params = new URLSearchParams(location.search);
      const ref = (params.get('ref') || '').trim();
      const BOOK = 'trojan';
      const KOFI_PROLOGUE_URL = 'https://ko-fi.com/post/Prologue--Cold-War-Open--By-Bailey-Ryder-A0A51I0KH0';
      const API_BASE = 'https://referral-codes-ten.vercel.app'; // your Vercel project

      // tiny util
      const showError = (text) => {
        document.body.style.display = 'block';
        document.getElementById('msg').textContent = text;
      };

      try {
        // 1) quick sanity
        if (!ref || ref.length < 4) {
          return showError('Page-link blocked. Referral code invalid, or not found.');
        }

        // 2) fetch allowlist, single-column CSV, no header
        const listRes = await fetch('https://raw.githubusercontent.com/SMorris-DaVinci/referral-codes/main/codes-trojan.csv', { cache: 'no-store' });
        if (!listRes.ok) throw new Error('Codes list fetch failed');
        const listText = await listRes.text();
        const valid = new Set(
          listText.split(/\r?\n/).map(s => s.trim()).filter(Boolean)
        );
        if (!valid.has(ref)) {
          return showError('Page-link blocked. Referral code invalid, or not found.');
        }

        // 3) session id (persist per browser)
        let sessionID = localStorage.getItem('session_id');
        if (!sessionID) {
          sessionID = (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + '-' + Math.random().toString(36).slice(2)));
          localStorage.setItem('session_id', sessionID);
        }

        // 4) store what we want to carry later (handy for future flows)
        localStorage.setItem('ref', ref);
        localStorage.setItem('book', BOOK);

        // 5) log referral to your API (non-blocking)
        try {
          await fetch(`${API_BASE}/api/log`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ref,
              timestamp: new Date().toISOString(),
              userAgent: navigator.userAgent,
              chapter: '',          // unknown at this hop
              book: BOOK,
              tipIntent: false,
              localStorage: JSON.stringify({ ref, book: BOOK }),
              sourceURL: document.referrer || '',
              ipAddress: '',
              urlParamsRaw: location.search.slice(1),
              sessionID
            })
          });
        } catch (_) { /* ignore — don’t block redirect */ }

        // 6) silent forward (no history entry)
        location.replace(KOFI_PROLOGUE_URL);

      } catch (err) {
        showError('Page-link blocked. Referral code invalid, or not found.');
      }
    })();
  </script>
</body>
</html>
